{% extends "base.html" %}

{% block title %}System Logs - Lead Manager Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-list-alt"></i> System Logs
        </h1>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="actionTypeFilter" class="px-4 py-2 border border-gray-300 rounded-md">
                <option value="">All Action Types</option>
                <option value="lead_updated">Lead Updated</option>
                <option value="agent_added">Agent Added</option>
                <option value="agent_updated">Agent Updated</option>
                <option value="agent_deleted">Agent Deleted</option>
                <option value="sync_forced">Sync Forced</option>
            </select>
            <select id="userTypeFilter" class="px-4 py-2 border border-gray-300 rounded-md">
                <option value="">All User Types</option>
                <option value="admin">Admin</option>
                <option value="seller">Seller</option>
            </select>
            <input type="text" id="leadIdFilter" placeholder="Lead ID"
                class="px-4 py-2 border border-gray-300 rounded-md">
            <button onclick="applyLogFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                <i class="fas fa-filter"></i> Apply Filters
            </button>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lead ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Old Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">New Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                    </tr>
                </thead>
                <tbody id="logsTable" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function loadLogs() {
    const actionType = document.getElementById('actionTypeFilter').value;
    const userType = document.getElementById('userTypeFilter').value;
    const leadId = document.getElementById('leadIdFilter').value;

    const params = new URLSearchParams();
    if (actionType) params.append('action_type', actionType);
    if (userType) params.append('user_type', userType);
    if (leadId) params.append('lead_id', leadId);

    try {
        const response = await apiCall(`/admin/api/logs?${params.toString()}`);
        if (!response) return;
        const data = await response.json();

        const tbody = document.getElementById('logsTable');
        if (data.logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No logs found</td></tr>';
            return;
        }

        tbody.innerHTML = data.logs.map(log => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.user_type || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.user_name || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.action_type || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.lead_id || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.old_value || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.new_value || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${log.details || '-'}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading logs:', error);
    }
}

function applyLogFilters() {
    loadLogs();
}

document.addEventListener('DOMContentLoaded', loadLogs);
</script>
{% endblock %}

